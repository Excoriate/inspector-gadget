name: ğŸ”„ Continuous Integration

on:
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: 1.67.0

jobs:
  ci:
    name: ğŸ§ª CI Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: ğŸ”§ Set up just
        uses: extractions/setup-just@v1

      - name: ğŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-shape0-dev libxcb-xfixes0-dev
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ”§ Auto-fix linting issues
        run: |
          echo "ğŸ”¨ Fixing linting issues..."
          just fix
          echo "âœ… Linting issues fixed"

      - name: ğŸš€ Run CI checks
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running CI checks..."
          just ci
          echo "âœ… CI checks completed successfully"

      - name: ğŸ‰ CI Success Notification
        if: success()
        run: |
          echo "::notice::ğŸŠ CI checks passed successfully!"

      - name: âŒ CI Failure Notification
        if: failure()
        run: |
          echo "::error::ğŸ’¥ CI checks failed. Please review the logs for details."

  functional-test:
    name: ğŸ§ª Functional Test
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: ğŸ”§ Set up just
        uses: extractions/setup-just@v1

      - name: ğŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-shape0-dev libxcb-xfixes0-dev
          echo "âœ… Dependencies installed successfully"

      - name: ğŸš€ Run functional test
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running functional test..."
          just test-cli-terragrunt
          echo "âœ… Functional test completed successfully"

      - name: ğŸ‰ Functional Test Success Notification
        if: success()
        run: |
          echo "::notice::ğŸŠ Functional test passed successfully!"

      - name: âŒ Functional Test Failure Notification
        if: failure()
        run: |
          echo "::error::ğŸ’¥ Functional test failed. Please review the logs for details."

  docker-ci:
    name: ğŸ³ Docker CI
    needs: [ci, functional-test]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v1

      - name: ğŸ—ï¸ Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t inspector-cli .
          echo "âœ… Docker image built successfully"

      - name: ğŸ§ª Test Docker image
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running CLI in Docker container..."
          docker run --rm inspector-cli --help
          echo "âœ… Docker image test passed"

      - name: ğŸš€ Run CI tests in Docker
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running CI tests in Docker container..."
          docker run --rm -v $(pwd):/usr/src/inspector-cli -w /usr/src/inspector-cli rust:${{ env.RUST_VERSION }} sh -c "
            apt-get update && 
            apt-get install -y just && 
            cargo test && 
            cargo clippy -- -D warnings && 
            cargo fmt -- --check && 
            just test-cli-terragrunt
          "
          echo "âœ… Docker CI tests completed successfully"

      - name: ğŸ‰ Docker CI Success Notification
        if: success()
        run: |
          echo "::notice::ğŸŠ Docker CI checks passed successfully!"

      - name: âŒ Docker CI Failure Notification
        if: failure()
        run: |
          echo "::error::ğŸ’¥ Docker CI checks failed. Please review the logs for details."